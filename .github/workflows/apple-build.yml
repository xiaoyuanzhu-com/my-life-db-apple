name: Apple Build and Deploy

on:
  push:
    branches:
      - main

concurrency:
  group: apple-build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-ios:
    name: Build iOS → TestFlight
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup signing
        env:
          CERTIFICATES_P12: ${{ secrets.CERTIFICATES_P12 }}
          CERTIFICATES_P12_PASSWORD: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
          DEV_CERTIFICATES_P12: ${{ secrets.DEV_CERTIFICATES_P12 }}
          DEV_CERTIFICATES_P12_PASSWORD: ${{ secrets.DEV_CERTIFICATES_P12_PASSWORD }}
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN_PATH"

          # Import distribution certificate
          echo "$CERTIFICATES_P12" | base64 --decode > "$RUNNER_TEMP/dist-cert.p12"
          security import "$RUNNER_TEMP/dist-cert.p12" \
            -k "$KEYCHAIN_PATH" \
            -P "$CERTIFICATES_P12_PASSWORD" \
            -T /usr/bin/codesign

          # Import development certificate
          echo "$DEV_CERTIFICATES_P12" | base64 --decode > "$RUNNER_TEMP/dev-cert.p12"
          security import "$RUNNER_TEMP/dev-cert.p12" \
            -k "$KEYCHAIN_PATH" \
            -P "$DEV_CERTIFICATES_P12_PASSWORD" \
            -T /usr/bin/codesign

          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Set keychain search list: temp keychain + system (for Apple CA certs)
          security list-keychains -d user -s "$KEYCHAIN_PATH" /Library/Keychains/System.keychain

          # Write API key for altool and xcodebuild
          mkdir -p ~/private_keys
          echo "$APP_STORE_CONNECT_PRIVATE_KEY" \
            > ~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8

          # Export for later steps
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Build iOS archive
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          xcodebuild archive \
            -project MyLifeDB.xcodeproj \
            -scheme MyLifeDB \
            -archivePath "$RUNNER_TEMP/MyLifeDB-iOS.xcarchive" \
            -destination "generic/platform=iOS" \
            -authenticationKeyPath ~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8 \
            -authenticationKeyID "$APP_STORE_CONNECT_KEY_ID" \
            -authenticationKeyIssuerID "$APP_STORE_CONNECT_ISSUER_ID" \
            -allowProvisioningUpdates

      - name: Export IPA
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/MyLifeDB-iOS.xcarchive" \
            -exportPath "$RUNNER_TEMP/ios-output" \
            -exportOptionsPlist ExportOptions-iOS.plist \
            -authenticationKeyPath ~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8 \
            -authenticationKeyID "$APP_STORE_CONNECT_KEY_ID" \
            -authenticationKeyIssuerID "$APP_STORE_CONNECT_ISSUER_ID" \
            -allowProvisioningUpdates

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          xcrun altool --upload-app \
            -f "$RUNNER_TEMP/ios-output/MyLifeDB.ipa" \
            -t ios \
            --apiKey "$APP_STORE_CONNECT_KEY_ID" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID"

      - name: Cleanup
        if: always()
        run: |
          security list-keychains -d user -s login.keychain-db
          security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
          rm -f "$RUNNER_TEMP/dist-cert.p12" "$RUNNER_TEMP/dev-cert.p12"
          rm -f ~/private_keys/AuthKey_*.p8
          rm -rf "$RUNNER_TEMP/MyLifeDB-iOS.xcarchive"
          rm -rf "$RUNNER_TEMP/ios-output"

  build-macos:
    name: Build macOS → DMG
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup signing
        env:
          CERTIFICATES_P12: ${{ secrets.CERTIFICATES_P12 }}
          CERTIFICATES_P12_PASSWORD: ${{ secrets.CERTIFICATES_P12_PASSWORD }}
          DEV_CERTIFICATES_P12: ${{ secrets.DEV_CERTIFICATES_P12 }}
          DEV_CERTIFICATES_P12_PASSWORD: ${{ secrets.DEV_CERTIFICATES_P12_PASSWORD }}
          APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -t 3600 -u "$KEYCHAIN_PATH"

          # Import distribution certificate
          echo "$CERTIFICATES_P12" | base64 --decode > "$RUNNER_TEMP/dist-cert.p12"
          security import "$RUNNER_TEMP/dist-cert.p12" \
            -k "$KEYCHAIN_PATH" \
            -P "$CERTIFICATES_P12_PASSWORD" \
            -T /usr/bin/codesign

          # Import development certificate
          echo "$DEV_CERTIFICATES_P12" | base64 --decode > "$RUNNER_TEMP/dev-cert.p12"
          security import "$RUNNER_TEMP/dev-cert.p12" \
            -k "$KEYCHAIN_PATH" \
            -P "$DEV_CERTIFICATES_P12_PASSWORD" \
            -T /usr/bin/codesign

          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Set keychain search list: temp keychain + system (for Apple CA certs)
          security list-keychains -d user -s "$KEYCHAIN_PATH" /Library/Keychains/System.keychain

          # Write API key for xcodebuild provisioning
          mkdir -p ~/private_keys
          echo "$APP_STORE_CONNECT_PRIVATE_KEY" \
            > ~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8

          # Export for later steps
          echo "KEYCHAIN_PATH=$KEYCHAIN_PATH" >> "$GITHUB_ENV"

      - name: Build macOS archive
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          xcodebuild archive \
            -project MyLifeDB.xcodeproj \
            -scheme MyLifeDB \
            -archivePath "$RUNNER_TEMP/MyLifeDB-macOS.xcarchive" \
            -destination "generic/platform=macOS" \
            -authenticationKeyPath ~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8 \
            -authenticationKeyID "$APP_STORE_CONNECT_KEY_ID" \
            -authenticationKeyIssuerID "$APP_STORE_CONNECT_ISSUER_ID" \
            -allowProvisioningUpdates

      - name: Export app
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        run: |
          xcodebuild -exportArchive \
            -archivePath "$RUNNER_TEMP/MyLifeDB-macOS.xcarchive" \
            -exportPath "$RUNNER_TEMP/macos-output" \
            -exportOptionsPlist ExportOptions-macOS.plist \
            -authenticationKeyPath ~/private_keys/AuthKey_${APP_STORE_CONNECT_KEY_ID}.p8 \
            -authenticationKeyID "$APP_STORE_CONNECT_KEY_ID" \
            -authenticationKeyIssuerID "$APP_STORE_CONNECT_ISSUER_ID" \
            -allowProvisioningUpdates

      - name: Create DMG
        run: |
          # Stage .app + Applications symlink for drag-and-drop install
          mkdir -p "$RUNNER_TEMP/dmg-staging"
          cp -R "$RUNNER_TEMP/macos-output/MyLifeDB.app" "$RUNNER_TEMP/dmg-staging/"
          ln -s /Applications "$RUNNER_TEMP/dmg-staging/Applications"

          # Create compressed DMG
          hdiutil create \
            -volname "MyLifeDB" \
            -srcfolder "$RUNNER_TEMP/dmg-staging" \
            -ov -format UDZO \
            "$RUNNER_TEMP/MyLifeDB.dmg"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyLifeDB-macOS-${{ github.sha }}
          path: ${{ runner.temp }}/MyLifeDB.dmg
          retention-days: 90

      - name: Cleanup
        if: always()
        run: |
          security list-keychains -d user -s login.keychain-db
          security delete-keychain "$KEYCHAIN_PATH" 2>/dev/null || true
          rm -f "$RUNNER_TEMP/dist-cert.p12" "$RUNNER_TEMP/dev-cert.p12"
          rm -f ~/private_keys/AuthKey_*.p8
          rm -rf "$RUNNER_TEMP/MyLifeDB-macOS.xcarchive"
          rm -rf "$RUNNER_TEMP/macos-output"
          rm -rf "$RUNNER_TEMP/dmg-staging"
          rm -f "$RUNNER_TEMP/MyLifeDB.dmg"
